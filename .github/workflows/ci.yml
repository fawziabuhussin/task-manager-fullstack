name: CI — Docker E2E

on:
  push:
  pull_request:

jobs:
  e2e-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Docker versions
        run: |
          docker --version
          docker compose version

      - name: Build & start stack (docker compose)
        run: docker compose up -d --build

      - name: Wait for API to be ready
        run: |
          # Needs jq for a simple sanity check
          sudo apt-get update && sudo apt-get install -y jq
          echo "Waiting for http://localhost:3000/api/auth/me ..."
          for i in {1..60}; do
            if curl -sS http://localhost:3000/api/auth/me | jq '.' >/dev/null 2>&1 ; then
              echo "API is up ✅"
              exit 0
            fi
            sleep 2
          done
          echo "API did not come up ❌"
          docker compose logs server || true
          exit 1

      - name: Run bash E2E tests
        run: |
          chmod +x tests/integration/run_tests.sh
          ./tests/integration/run_tests.sh

      - name: Dump compose logs on failure
        if: failure()
        run: docker compose logs --no-color > compose-logs.txt

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: compose-logs.txt

      - name: Tear down
        if: always()
        run: docker compose down -v

  e2e-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Docker versions
        shell: pwsh
        run: |
          docker --version
          docker compose version

      - name: Build & start stack (docker compose)
        shell: pwsh
        run: docker compose up -d --build

      - name: Wait for API to be ready
        shell: pwsh
        run: |
          Write-Host "Waiting for http://localhost:3000/api/auth/me ..."
          $ok = $false
          1..60 | ForEach-Object {
            try {
              $resp = Invoke-RestMethod http://localhost:3000/api/auth/me -TimeoutSec 2
              if ($resp) { $ok = $true; break }
            } catch { Start-Sleep -Seconds 2 }
          }
          if (-not $ok) {
            Write-Host "API did not come up ❌"
            docker compose logs server
            exit 1
          }
          Write-Host "API is up ✅"

      - name: Run PowerShell E2E tests
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File tests/integration/run_tests.ps1

      - name: Dump compose logs on failure
        if: failure()
        shell: pwsh
        run: docker compose logs --no-color > compose-logs.txt

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs-windows
          path: compose-logs.txt

      - name: Tear down
        if: always()
        shell: pwsh
        run: docker compose down -v
